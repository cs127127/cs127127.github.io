<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Sharing V2</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; 
            --secondary: #10b981; 
            --danger: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg-gradient);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; 
        }
        .control-panel { 
            background: var(--card-bg); padding: 2rem; border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 100%; max-width: 500px; text-align: center; margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        h1 { color: var(--primary); margin-bottom: 0.5rem; }
        .desc { color: #6b7280; font-size: 0.85rem; margin-bottom: 1.5rem; }
        .input-group { display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1.5rem; }
        input { padding: 0.8rem; border: 2px solid #e5e7eb; border-radius: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); }
        .button-stack { display: flex; gap: 10px; }
        button { flex: 1; padding: 0.8rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; }
        .btn-share { background: var(--primary); }
        .btn-join { background: var(--secondary); }
        .btn-stop { background: var(--danger); display: none; width: 100%; margin-top: 10px; }
        .status { display: inline-block; margin-top: 1rem; padding: 0.4rem 1rem; background: #f3f4f6; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
        .status.online { background: #dcfce7; color: #166534; }
        .video-container { width: 100%; max-width: 900px; background: #000; border-radius: 15px; overflow: hidden; aspect-ratio: 16 / 9; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h1>Screen Sharing</h1>
        <p class="desc">V2</p>
        <div class="input-group">
            <input type="text" id="roomName" placeholder="Room Name">
            <input type="password" id="passcode" placeholder="Passcode">
        </div>
        <div class="button-stack">
            <button id="btnHost" class="btn-share">Share Screen</button>
            <button id="btnJoin" class="btn-join">Join Room</button>
        </div>
        <button id="btnStop" class="btn-stop">Disconnect</button>
        <div id="statusLabel" class="status">Ready</div>
    </div>

    <div class="video-container">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>

    <script>
        let peer = null;
        let localStream = null;

        /**
         * EDUROAM OPTIMIZATION:
         * 1. Use OpenRelay public TURN servers on port 443 (looks like HTTPS traffic).
         * 2. Force 'relay' policy to skip failed P2P attempts in strict NATs.
         */
        const peerConfig = {
    config: {
        'iceServers': [
            {
                urls: 'turns:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            }
        ],
        'iceTransportPolicy': 'relay', 
        'iceCandidatePoolSize': 0
    }
};

        const el = {
            room: document.getElementById('roomName'),
            pass: document.getElementById('passcode'),
            btnHost: document.getElementById('btnHost'),
            btnJoin: document.getElementById('btnJoin'),
            btnStop: document.getElementById('btnStop'),
            video: document.getElementById('remoteVideo'),
            status: document.getElementById('statusLabel')
        };

        function setStatus(msg, isOnline = true) {
            el.status.innerText = msg;
            el.status.className = isOnline ? 'status online' : 'status';
        }

        function getFullId() {
            const r = el.room.value.trim();
            const p = el.pass.value.trim();
            return r && p ? `as_v2_${r}_${p}` : null;
        }

        // --- HOST LOGIC ---
        el.btnHost.onclick = async () => {
            // 1. 立即检查输入，不涉及异步操作
            const id = getFullId();
            if (!id) return alert("Please enter Room Name and Passcode");
        
            try {
                // 2. 必须先触发弹窗！不要在这一行之前放置任何 await 操作
                // 这样可以确保浏览器识别到这是由用户点击直接触发的
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { 
                        frameRate: { max: 15 }, 
                        width: { max: 1280 } 
                    }, 
                    audio: false 
                });
        
                // 3. 弹窗成功后，再初始化 Peer 和后续逻辑
                localStream = stream;
                peer = new Peer(id, peerConfig);
        
                peer.on('open', () => {
                    el.video.srcObject = localStream;
                    el.video.style.display = 'block';
                    el.placeholder.style.display = 'none';
                    el.btnStop.style.display = 'block';
                    el.btnHost.disabled = true;
                    el.btnJoin.disabled = true;
                    setStatus("Live (Relayed via OpenRelay)");
                });
        
                peer.on('call', (call) => {
                    call.answer(localStream);
                });
        
                peer.on('error', (err) => {
                    if (err.type === 'id-taken') alert("Room occupied!");
                    resetUI();
                });
        
                // 处理用户点击“停止共享”按钮的情况
                localStream.getVideoTracks()[0].onended = () => resetUI();
        
                    } catch (e) {
                        console.error("Capture Error:", e);
                        if (e.name === 'NotAllowedError') {
                            alert("Permission Denied: Please enable 'Screen Recording' in System Settings (macOS) or allow browser permissions.");
                        } else {
                            setStatus("Error: " + e.message, true);
                        }
                    }
            };

        // --- VIEWER LOGIC ---
        el.btnJoin.onclick = () => {
            const hostId = getFullId();
            if(!hostId) return alert("Please enter Room Name and Passcode");

            peer = new Peer(peerConfig);
            
            peer.on('open', () => {
                setStatus("Connecting via TURN Relay...");
                
                // Create dummy stream to trigger WebRTC handshake
                const canvas = document.createElement('canvas');
                canvas.width = canvas.height = 1;
                const call = peer.call(hostId, canvas.captureStream());

                call.on('stream', stream => {
                    el.video.srcObject = stream;
                    setStatus("Connected (Relayed)");
                    el.btnStop.style.display = 'block';
                    el.btnHost.disabled = el.btnJoin.disabled = true;
                });
            });

            peer.on('error', err => {
                setStatus("Connection Failed: " + err.type, false);
            });
        };

        el.btnStop.onclick = () => location.reload();
    </script>
</body>
</html>
